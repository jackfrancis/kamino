# Auto Update

This is a higher level description of the basic functions of the VMSS-Prototype Pattern (Kamino) system.  This goes into deep details as to what you are doing on the machine.

## Example

Below is the canonical way to run vmss-prototype on your cluster using our published Helm Chart to do automatic updates to all VMSS pools in the cluster:

```bash
$ helm install --repo https://jackfrancis.github.io/kamino/ \
  update-vmss-model-images \
  vmss-prototype \
  --namespace default \
  --set kamino.scheduleOnControlPlane=true \
  --set kamino.logLevel=DEBUG \
  --set kamino.targetVMSS=ALL \
  --set kamino.auto.lastPatchAnnotation=LatestOSPatch \
  --set kamino.auto.pendingRebootAnnotation=PendingReboot
```


# Annotated logs from a single VMSS cluster run with automatic mode

This cluster has tools that automatically apply OS patches and do reboots as needed, setting the annotations needed.  There is a PR for the open source [Kured](https://github.com/weaveworks/kured) tool that will have it set these annotations as needed but my test environment did not have that custom build so we used our internal tool.

## First run with effectively the above helm command settings

`vmss-prototype` always logs the command line as it starts for easier debugging.
```
2021-01-14T17:08:17.508568931Z CMD: ['/usr/bin/vmss-prototype' '--in-cluster' '--log-level' 'DEBUG' '--log-prefix' 'auto-update' 'auto-update' '--new-updated-nodes' '0' '--grace-period' '5' '--max-history' '3' '--last-patch-annotation' 'LatestOSPatch' '--pending-reboot-annotation' 'PendingReboot' '--minimum-ready-time' '1h' '--minimum-candidates' '1']
```

Note that at this point, all of the auto-update log lines will have "auto-update" prefixed.  (The timestamps are from kubernetes `kubectl logs --timestamps` and are not ones generated by `vmss-prototype`)

`vmss-prototype` logging into the Azure world using the azure.json/node credentials
```
2021-01-14T17:08:17.508621031Z auto-update	INFO: ===> Executing command: ['az' 'cloud' 'set' '--name' 'AzureCloud']
2021-01-14T17:08:19.842976361Z auto-update	INFO: ===> Executing command: ['az' 'login' '***']
2021-01-14T17:08:20.826313834Z auto-update	INFO: ===> Executing command: ['az' 'account' 'set' '--subscription' '00000000-0000-0000-0000-000000000000']
```

`vmss-prototype` is now getting the layout of the cluster
```
2021-01-14T17:08:21.124903169Z auto-update	INFO: ===> Executing command: ['kubectl' 'get' 'nodes' '--output' 'jsonpath={.items[*].metadata.name}']
2021-01-14T17:08:21.836445781Z auto-update	INFO: ===> Executing command: ['kubectl' 'get' 'nodes' '--output' 'json']
```

The first VMSS pool is being evaluated.  Note that since we have no prior images, the "version" is set to 0000.00.00
```
2021-01-14T17:08:22.004337469Z auto-update	INFO: ===> Executing command: ['az' 'sig' 'image-version' 'list' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--gallery-name' 'SIG_testCluster1' '--gallery-image-definition' 'kamino-k8s-agentpool1-12345678-vmss-prototype']
2021-01-14T17:08:24.731700447Z auto-update	DEBUG: Latest image for VMSS k8s-agentpool1-12345678-vmss is 0000.00.00
```

Now we evaluate all of the nodes, filtering out those that are not valid candidates to be a prototype.  Obviously, all of the master nodes are filtered out since they are not in the VMSS.  In this case, none of the VMSS nodes (only 3) were filtered out.  A selection was made to use node `k8s-agentpool1-12345678-vmss000002`
```
2021-01-14T17:08:24.737098582Z auto-update	DEBUG: IGNORED: Node k8s-master-12345678-0 not part of vmss k8s-agentpool1-12345678-vmss
2021-01-14T17:08:24.737123482Z auto-update	DEBUG: IGNORED: Node k8s-master-12345678-1 not part of vmss k8s-agentpool1-12345678-vmss
2021-01-14T17:08:24.737192282Z auto-update	DEBUG: IGNORED: Node k8s-master-12345678-2 not part of vmss k8s-agentpool1-12345678-vmss
2021-01-14T17:08:24.737287783Z auto-update	INFO: VMSS k8s-agentpool1-12345678-vmss: Picked candiate node k8s-agentpool1-12345678-vmss000002 from 3 candidates
2021-01-14T17:08:24.737605985Z auto-update	INFO: ===> Executing command: ['/usr/bin/vmss-prototype' '--log-level' 'DEBUG' '--log-prefix' 'k8s-agentpool1-12345678-vmss' 'update' '--resource-group' 'testCluster1' '--new-updated-nodes' '0' '--max-history' '3' '--grace-period' '5' '--target-node' 'k8s-agentpool1-12345678-vmss000002' '--subscription' '00000000-0000-0000-0000-000000000000']
```

`vmss-prototype` now calls the vmss-prototype update process.  One of these is spawned for each pool that has is discovered to have a need and candidate for prototype update.  Note that the log line prefix changes to the pool this log line is about.  We do that such that multiple VMSS pools being operated on at once can be correctly parsed in the logs.  As this was for testing, we had set a rather short grace-period in order to reduce the time of the test and to show what happens when drain times out (auto-retry)
```
2021-01-14T17:08:24.809937054Z CMD: ['/usr/bin/vmss-prototype' '--log-level' 'DEBUG' '--log-prefix' 'k8s-agentpool1-12345678-vmss' 'update' '--resource-group' 'testCluster1' '--new-updated-nodes' '0' '--max-history' '3' '--grace-period' '5' '--target-node' 'k8s-agentpool1-12345678-vmss000002' '--subscription' '00000000-0000-0000-0000-000000000000']
2021-01-14T17:08:24.809977454Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['kubectl' 'get' 'node' 'k8s-agentpool1-12345678-vmss000002']
2021-01-14T17:08:24.917506551Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'sig' 'show' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--gallery-name' 'SIG_testCluster1']
2021-01-14T17:08:26.278740174Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'sig' 'create' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--gallery-name' 'SIG_testCluster1' '--description' 'Kamino VMSS images']
2021-01-14T17:08:59.907578874Z k8s-agentpool1-12345678-vmss	INFO: Processing VMSS k8s-agentpool1-12345678-vmss
2021-01-14T17:08:59.907799675Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'sig' 'image-definition' 'show' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--gallery-name' 'SIG_testCluster1' '--gallery-image-definition' 'kamino-k8s-agentpool1-12345678-vmss-prototype']
2021-01-14T17:09:01.400376753Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'sig' 'image-definition' 'create' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--gallery-name' 'SIG_testCluster1' '--gallery-image-definition' 'kamino-k8s-agentpool1-12345678-vmss-prototype' '--publisher' 'VMSS-Prototype-Pattern' '--offer' 'testCluster1' '--sku' 'k8s-agentpool1-12345678-vmss' '--os-type' 'Linux' '--os-state' 'generalized']
2021-01-14T17:09:34.847800038Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'sig' 'image-version' 'list' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--gallery-name' 'SIG_testCluster1' '--gallery-image-definition' 'kamino-k8s-agentpool1-12345678-vmss-prototype']
2021-01-14T17:09:37.681615916Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'snapshot' 'show' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--name' 'snapshot_k8s-agentpool1-12345678-vmss']
2021-01-14T17:09:39.159230799Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'vmss' 'show' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--name' 'k8s-agentpool1-12345678-vmss' '--instance-id' '2']
2021-01-14T17:09:40.780999517Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['kubectl' 'annotate' 'node' 'k8s-agentpool1-12345678-vmss000002' 'cluster-autoscaler.kubernetes.io/scale-down-disabled=true' '--overwrite']
2021-01-14T17:09:40.920064219Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['kubectl' 'cordon' 'k8s-agentpool1-12345678-vmss000002']
2021-01-14T17:09:41.055779799Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['kubectl' 'drain' '--ignore-daemonsets' '--delete-local-data' '--force' '--grace-period' '5' '--timeout' '15s' 'k8s-agentpool1-12345678-vmss000002']
2021-01-14T17:09:59.555616890Z k8s-agentpool1-12345678-vmss	WARNING: Attempt 1: Command failed with exit code 1.  Retrying in 8s ...
2021-01-14T17:10:07.562647530Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['kubectl' 'drain' '--ignore-daemonsets' '--delete-local-data' '--force' '--grace-period' '5' '--timeout' '15s' 'k8s-agentpool1-12345678-vmss000002'] #  ... try #2
2021-01-14T17:10:13.384478296Z k8s-agentpool1-12345678-vmss	INFO: ===> Completed in 32.33s: ['kubectl' 'drain' '--ignore-daemonsets' '--delete-local-data' '--force' '--grace-period' '5' '--timeout' '15s' 'k8s-agentpool1-12345678-vmss000002'] # RC=0
2021-01-14T17:10:13.384973400Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'vmss' 'deallocate' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--name' 'k8s-agentpool1-12345678-vmss' '--instance-ids' '2']
2021-01-14T17:13:16.747177869Z k8s-agentpool1-12345678-vmss	INFO: ===> Completed in 183.36s: ['az' 'vmss' 'deallocate' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--name' 'k8s-agentpool1-12345678-vmss' '--instance-ids' '2'] # RC=0
2021-01-14T17:13:16.747427571Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'snapshot' 'create' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--name' 'snapshot_k8s-agentpool1-12345678-vmss' '--source' '/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/testCluster1/providers/Microsoft.Compute/disks/k8s-agentpool1-18861k8s-agentpool1-188617OS__1_31149be82f654bdf8f25e77b8f64afae' '--tags' 'BuiltFrom=k8s-agentpool1-12345678-vmss000002' 'BuiltAt=2021-01-14 17:13:16.747072']
2021-01-14T17:13:22.566227674Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'vmss' 'start' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--name' 'k8s-agentpool1-12345678-vmss' '--instance-ids' '2' '--no-wait']
2021-01-14T17:13:24.087514857Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['kubectl' 'uncordon' 'k8s-agentpool1-12345678-vmss000002']
2021-01-14T17:13:24.212719270Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['kubectl' 'annotate' 'node' 'k8s-agentpool1-12345678-vmss000002' 'cluster-autoscaler.kubernetes.io/scale-down-disabled-']
2021-01-14T17:13:24.341068604Z k8s-agentpool1-12345678-vmss	INFO: Creating sig image version - this can take quite a long time...
2021-01-14T17:13:24.342181812Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'sig' 'image-version' 'create' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--gallery-name' 'SIG_testCluster1' '--gallery-image-definition' 'kamino-k8s-agentpool1-12345678-vmss-prototype' '--gallery-image-version' '2021.01.14' '--replica-count' '3' '--os-snapshot' 'snapshot_k8s-agentpool1-12345678-vmss' '--tags' 'BuiltFrom=k8s-agentpool1-12345678-vmss000002' 'BuiltAt=2021-01-14 17:13:16.747072' '--storage-account-type' 'Standard_ZRS']
2021-01-14T18:57:50.116067018Z k8s-agentpool1-12345678-vmss	INFO: ===> Completed in 6265.77s: ['az' 'sig' 'image-version' 'create' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--gallery-name' 'SIG_testCluster1' '--gallery-image-definition' 'kamino-k8s-agentpool1-12345678-vmss-prototype' '--gallery-image-version' '2021.01.14' '--replica-count' '3' '--os-snapshot' 'snapshot_k8s-agentpool1-12345678-vmss' '--tags' 'BuiltFrom=k8s-agentpool1-12345678-vmss000002' 'BuiltAt=2021-01-14 17:13:16.747072' '--storage-account-type' 'Standard_ZRS'] # RC=0
2021-01-14T18:57:50.116563221Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'snapshot' 'delete' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--name' 'snapshot_k8s-agentpool1-12345678-vmss']
2021-01-14T18:58:21.845822732Z k8s-agentpool1-12345678-vmss	INFO: Latest image: /subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/testCluster1/providers/Microsoft.Compute/galleries/SIG_testCluster1/images/kamino-k8s-agentpool1-12345678-vmss-prototype/versions/2021.01.14
2021-01-14T18:58:21.846029433Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'sig' 'image-version' 'list' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--gallery-name' 'SIG_testCluster1' '--gallery-image-definition' 'kamino-k8s-agentpool1-12345678-vmss-prototype']
2021-01-14T18:58:24.469296948Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'vmss' 'show' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--name' 'k8s-agentpool1-12345678-vmss']
2021-01-14T18:58:25.820369775Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'vmss' 'update' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--name' 'k8s-agentpool1-12345678-vmss' '--set' 'virtualMachineProfile.storageProfile.imageReference.id=/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/testCluster1/providers/Microsoft.Compute/galleries/SIG_testCluster1/images/kamino-k8s-agentpool1-12345678-vmss-prototype' 'virtualMachineProfile.storageProfile.imageReference.sku=null' 'virtualMachineProfile.storageProfile.imageReference.offer=null' 'virtualMachineProfile.storageProfile.imageReference.publisher=null' 'virtualMachineProfile.storageProfile.imageReference.version=null' 'virtualMachineProfile.osProfile.customData=I2Nsb3VkLWNvbmZpZwo=']
2021-01-14T18:58:38.931921916Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'vmss' 'show' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--name' 'k8s-agentpool1-12345678-vmss']
2021-01-14T18:58:40.245728688Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'vmss' 'extension' 'list' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--vmss-name' 'k8s-agentpool1-12345678-vmss']
```

Now that everything has completed, the update process continues by asking to render the status of the cluster's prototype images.
```
2021-01-14T18:58:41.788250322Z auto-update	INFO: ===> Executing command: ['/usr/bin/vmss-prototype' 'status' '--resource-group' 'testCluster1' '--subscription' '00000000-0000-0000-0000-000000000000']
2021-01-14T18:58:51.100361012Z VMSS Prototype Status for cluster:
2021-01-14T18:58:51.100407612Z testCluster1: k8s-agentpool1-12345678-vmss: VMSS Prototype Image Version 2021.01.14 - Succeeded - BuiltFrom: k8s-agentpool1-12345678-vmss000002 @ 2021-01-14 17:13:16.747072
2021-01-14T18:58:51.100418112Z testCluster1: k8s-agentpool1-12345678-vmss: Configured to use latest VMSS Prototype Image Definition
```

Note that this cluster now has one VMSS configured to use the image that we just created.  Since this was the first run, there are no historical images.

## A second run of the auto-update

Note that running auto-update again, when there are no new updates available is a no-op and runs relatively quickly.  In our large production clusters we regularly (via a kubernetes cronjob) run the auto update process such that it builds a fresh prototype image automatically after OS patches are deployed and stable.

See how this whole thing completed in less than 15 seconds, including collecting the status of the cluster nodes and prototype images.  On very large clusters, this time is basically the same.  It mainly varies based on Azure API performance in listing the images that have already been created.

```
2021-01-14T20:55:17.378235221Z CMD: ['/usr/bin/vmss-prototype' '--in-cluster' '--log-level' 'DEBUG' '--log-prefix' 'auto-update' 'auto-update' '--new-updated-nodes' '0' '--grace-period' '5' '--max-history' '3' '--last-patch-annotation' 'LatestOSPatch' '--pending-reboot-annotation' 'PendingReboot' '--minimum-ready-time' '1h' '--minimum-candidates' '1']
2021-01-14T20:55:17.378292922Z auto-update	INFO: ===> Executing command: ['az' 'cloud' 'set' '--name' 'AzureCloud']
2021-01-14T20:55:20.436657688Z auto-update	INFO: ===> Executing command: ['az' 'login' '***']
2021-01-14T20:55:21.484097363Z auto-update	INFO: ===> Executing command: ['az' 'account' 'set' '--subscription' '00000000-0000-0000-0000-000000000000']
2021-01-14T20:55:21.802708484Z auto-update	INFO: ===> Executing command: ['kubectl' 'get' 'nodes' '--output' 'jsonpath={.items[*].metadata.name}']
2021-01-14T20:55:22.498723219Z auto-update	INFO: ===> Executing command: ['kubectl' 'get' 'nodes' '--output' 'json']
2021-01-14T20:55:22.677031606Z auto-update	INFO: ===> Executing command: ['az' 'sig' 'image-version' 'list' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--gallery-name' 'SIG_testCluster1' '--gallery-image-definition' 'kamino-k8s-agentpool1-12345678-vmss-prototype']
2021-01-14T20:55:25.489750037Z auto-update	DEBUG: Latest image for VMSS k8s-agentpool1-12345678-vmss is 2021.01.14
2021-01-14T20:55:25.490229940Z auto-update	DEBUG: IGNORED: Node k8s-agentpool1-12345678-vmss000009 latest patch of 2021.01.10 not newer that latest image version 2021.01.14
2021-01-14T20:55:25.490313041Z auto-update	DEBUG: IGNORED: Node k8s-agentpool1-12345678-vmss00000a latest patch of 2021.01.10 not newer that latest image version 2021.01.14
2021-01-14T20:55:25.490511842Z auto-update	DEBUG: IGNORED: Node k8s-agentpool1-12345678-vmss00000c does not have a last patch annotation: LatestOSPatch
2021-01-14T20:55:25.490595742Z auto-update	DEBUG: IGNORED: Node k8s-agentpool1-12345678-vmss00000d does not have a last patch annotation: LatestOSPatch
2021-01-14T20:55:25.490629143Z auto-update	DEBUG: IGNORED: Node k8s-master-12345678-0 not part of vmss k8s-agentpool1-12345678-vmss
2021-01-14T20:55:25.490687143Z auto-update	DEBUG: IGNORED: Node k8s-master-12345678-1 not part of vmss k8s-agentpool1-12345678-vmss
2021-01-14T20:55:25.490761644Z auto-update	DEBUG: IGNORED: Node k8s-master-12345678-2 not part of vmss k8s-agentpool1-12345678-vmss
2021-01-14T20:55:25.490907945Z auto-update	INFO: IGNORED: VMSS k8s-agentpool1-12345678-vmss: Found 0 candidates - minimum candidates is 1
2021-01-14T20:55:25.491264247Z auto-update	INFO: ===> Executing command: ['/usr/bin/vmss-prototype' 'status' '--resource-group' 'testCluster1' '--subscription' '00000000-0000-0000-0000-000000000000']
2021-01-14T20:55:31.630965033Z VMSS Prototype Status for cluster:
2021-01-14T20:55:31.631010933Z testCluster1: k8s-agentpool1-12345678-vmss: VMSS Prototype Image Version 2021.01.14 - Succeeded - BuiltFrom: k8s-agentpool1-12345678-vmss000002 @ 2021-01-14 17:13:16.747072
2021-01-14T20:55:31.631018933Z testCluster1: k8s-agentpool1-12345678-vmss: Configured to use latest VMSS Prototype Image Definition
```


# Logs from a 2 VMSS cluster run with automatic mode

This cluster has tools that automatically apply OS patches and do reboots as needed, setting the annotations needed.  There is a PR for the open source [Kured](https://github.com/weaveworks/kured) tool that will have it set these annotations as needed but my test environment did not have that custom build so we used our internal tool.

## A first run with the same settings but on a cluster with 2 VMSS pools.

This run is just like the first run on a single pool cluster only it found 2 pools that have prototype candidates to process.  Note how these run in parallel.  Most of the real processing happens in Azure and this one was especially slow - must have had some significant activity within my test subscription at the time.

```
2021-04-01T21:27:29.616180727Z CMD: ['/usr/bin/vmss-prototype' '--in-cluster' '--log-level' 'DEBUG' '--log-prefix' 'auto-update' 'auto-update' '--new-updated-nodes' '0' '--grace-period' '5' '--max-history' '3' '--last-patch-annotation' 'LatestOSPatch' '--pending-reboot-annotation' 'PendingReboot' '--minimum-ready-time' '5m' '--minimum-candidates' '1' '--maximum-image-age' '15']
2021-04-01T21:27:29.616212928Z auto-update	INFO: ===> Executing command: ['az' 'cloud' 'set' '--name' 'AzureCloud']
2021-04-01T21:27:31.824017020Z auto-update	INFO: ===> Executing command: ['az' 'login' '***']
2021-04-01T21:27:32.789011628Z auto-update	INFO: ===> Executing command: ['az' 'account' 'set' '--subscription' '00000000-0000-0000-0000-000000000001']
2021-04-01T21:27:32.991444516Z auto-update	INFO: ===> Executing command: ['kubectl' 'get' 'nodes' '--output' 'jsonpath={.items[*].metadata.name}']
2021-04-01T21:27:33.657669815Z auto-update	INFO: ===> Executing command: ['kubectl' 'get' 'nodes' '--output' 'json']
2021-04-01T21:27:33.762430251Z auto-update	INFO: ===> Executing command: ['az' 'sig' 'image-version' 'list' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2' '--gallery-image-definition' 'kamino-k8s-agentpool1-33778956-vmss-prototype']
2021-04-01T21:27:39.290835849Z auto-update	DEBUG: Latest image for VMSS k8s-agentpool1-33778956-vmss is 0000.00.00
2021-04-01T21:27:39.292895703Z auto-update	DEBUG: CANDIDATE: Node k8s-agentpool1-33778956-vmss000000 ready for 1706s
2021-04-01T21:27:39.292927004Z auto-update	DEBUG: CANDIDATE: Node k8s-agentpool1-33778956-vmss000001 ready for 2007s
2021-04-01T21:27:39.292941404Z auto-update	DEBUG: IGNORED: Node k8s-agentpool1-33778956-vmss000002 is the same as the node we are running on
2021-04-01T21:27:39.292944904Z auto-update	DEBUG: IGNORED: Node k8s-agentpool2-33778956-vmss000000 not part of vmss k8s-agentpool1-33778956-vmss
2021-04-01T21:27:39.292980705Z auto-update	DEBUG: IGNORED: Node k8s-agentpool2-33778956-vmss000001 not part of vmss k8s-agentpool1-33778956-vmss
2021-04-01T21:27:39.292997706Z auto-update	DEBUG: IGNORED: Node k8s-agentpool2-33778956-vmss000002 not part of vmss k8s-agentpool1-33778956-vmss
2021-04-01T21:27:39.293042607Z auto-update	DEBUG: IGNORED: Node k8s-master-33778956-0 not part of vmss k8s-agentpool1-33778956-vmss
2021-04-01T21:27:39.293052107Z auto-update	DEBUG: IGNORED: Node k8s-master-33778956-1 not part of vmss k8s-agentpool1-33778956-vmss
2021-04-01T21:27:39.293055307Z auto-update	DEBUG: IGNORED: Node k8s-master-33778956-2 not part of vmss k8s-agentpool1-33778956-vmss
2021-04-01T21:27:39.293094508Z auto-update	INFO: VMSS k8s-agentpool1-33778956-vmss: Picked candiate node k8s-agentpool1-33778956-vmss000001 from 2 candidates
2021-04-01T21:27:39.293262613Z auto-update	INFO: ===> Executing command: ['/usr/bin/vmss-prototype' '--log-level' 'DEBUG' '--log-prefix' 'k8s-agentpool1-33778956-vmss' 'update' '--resource-group' 'testCluster2' '--new-updated-nodes' '0' '--max-history' '3' '--grace-period' '5' '--target-node' 'k8s-agentpool1-33778956-vmss000001' '--subscription' '00000000-0000-0000-0000-000000000001']
2021-04-01T21:27:39.293562921Z auto-update	INFO: ===> Executing command: ['az' 'sig' 'image-version' 'list' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2' '--gallery-image-definition' 'kamino-k8s-agentpool2-33778956-vmss-prototype']
2021-04-01T21:27:39.330095074Z CMD: ['/usr/bin/vmss-prototype' '--log-level' 'DEBUG' '--log-prefix' 'k8s-agentpool1-33778956-vmss' 'update' '--resource-group' 'testCluster2' '--new-updated-nodes' '0' '--max-history' '3' '--grace-period' '5' '--target-node' 'k8s-agentpool1-33778956-vmss000001' '--subscription' '00000000-0000-0000-0000-000000000001']
2021-04-01T21:27:39.330122074Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'get' 'node' 'k8s-agentpool1-33778956-vmss000001']
2021-04-01T21:27:39.412174215Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['az' 'sig' 'show' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2']
2021-04-01T21:27:40.584345890Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['az' 'sig' 'create' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2' '--description' 'Kamino VMSS images']
2021-04-01T21:27:44.163504306Z auto-update	DEBUG: Latest image for VMSS k8s-agentpool2-33778956-vmss is 0000.00.00
2021-04-01T21:27:44.163537507Z auto-update	DEBUG: IGNORED: Node k8s-agentpool1-33778956-vmss000000 not part of vmss k8s-agentpool2-33778956-vmss
2021-04-01T21:27:44.163542307Z auto-update	DEBUG: IGNORED: Node k8s-agentpool1-33778956-vmss000001 not part of vmss k8s-agentpool2-33778956-vmss
2021-04-01T21:27:44.163546107Z auto-update	DEBUG: IGNORED: Node k8s-agentpool1-33778956-vmss000002 not part of vmss k8s-agentpool2-33778956-vmss
2021-04-01T21:27:44.163815814Z auto-update	DEBUG: CANDIDATE: Node k8s-agentpool2-33778956-vmss000000 ready for 2096s
2021-04-01T21:27:44.163830915Z auto-update	DEBUG: CANDIDATE: Node k8s-agentpool2-33778956-vmss000001 ready for 1735s
2021-04-01T21:27:44.163908317Z auto-update	DEBUG: CANDIDATE: Node k8s-agentpool2-33778956-vmss000002 ready for 1584s
2021-04-01T21:27:44.163913417Z auto-update	DEBUG: IGNORED: Node k8s-master-33778956-0 not part of vmss k8s-agentpool2-33778956-vmss
2021-04-01T21:27:44.163915917Z auto-update	DEBUG: IGNORED: Node k8s-master-33778956-1 not part of vmss k8s-agentpool2-33778956-vmss
2021-04-01T21:27:44.163934217Z auto-update	DEBUG: IGNORED: Node k8s-master-33778956-2 not part of vmss k8s-agentpool2-33778956-vmss
2021-04-01T21:27:44.163998119Z auto-update	INFO: VMSS k8s-agentpool2-33778956-vmss: Picked candiate node k8s-agentpool2-33778956-vmss000000 from 3 candidates
2021-04-01T21:27:44.164280726Z auto-update	INFO: ===> Executing command: ['/usr/bin/vmss-prototype' '--log-level' 'DEBUG' '--log-prefix' 'k8s-agentpool2-33778956-vmss' 'update' '--resource-group' 'testCluster2' '--new-updated-nodes' '0' '--max-history' '3' '--grace-period' '5' '--target-node' 'k8s-agentpool2-33778956-vmss000000' '--subscription' '00000000-0000-0000-0000-000000000001']
2021-04-01T21:27:44.200995983Z CMD: ['/usr/bin/vmss-prototype' '--log-level' 'DEBUG' '--log-prefix' 'k8s-agentpool2-33778956-vmss' 'update' '--resource-group' 'testCluster2' '--new-updated-nodes' '0' '--max-history' '3' '--grace-period' '5' '--target-node' 'k8s-agentpool2-33778956-vmss000000' '--subscription' '00000000-0000-0000-0000-000000000001']
2021-04-01T21:27:44.201033184Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'get' 'node' 'k8s-agentpool2-33778956-vmss000000']
2021-04-01T21:27:44.276734157Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['az' 'sig' 'show' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2']
2021-04-01T21:27:45.583577913Z k8s-agentpool2-33778956-vmss	INFO: Processing VMSS k8s-agentpool2-33778956-vmss
2021-04-01T21:27:45.583735517Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['az' 'sig' 'image-definition' 'show' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2' '--gallery-image-definition' 'kamino-k8s-agentpool2-33778956-vmss-prototype']
2021-04-01T21:27:46.917185158Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['az' 'sig' 'image-definition' 'create' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2' '--gallery-image-definition' 'kamino-k8s-agentpool2-33778956-vmss-prototype' '--publisher' 'VMSS-Prototype-Pattern' '--offer' 'testCluster2' '--sku' 'k8s-agentpool2-33778956-vmss' '--os-type' 'Linux' '--os-state' 'generalized']
2021-04-01T21:28:14.376147106Z k8s-agentpool1-33778956-vmss	INFO: Processing VMSS k8s-agentpool1-33778956-vmss
2021-04-01T21:28:14.376225808Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['az' 'sig' 'image-definition' 'show' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2' '--gallery-image-definition' 'kamino-k8s-agentpool1-33778956-vmss-prototype']
2021-04-01T21:28:15.317867417Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['az' 'sig' 'image-definition' 'create' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2' '--gallery-image-definition' 'kamino-k8s-agentpool1-33778956-vmss-prototype' '--publisher' 'VMSS-Prototype-Pattern' '--offer' 'testCluster2' '--sku' 'k8s-agentpool1-33778956-vmss' '--os-type' 'Linux' '--os-state' 'generalized']
2021-04-01T21:28:20.673342370Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['az' 'sig' 'image-version' 'list' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2' '--gallery-image-definition' 'kamino-k8s-agentpool2-33778956-vmss-prototype']
2021-04-01T21:28:24.046707807Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['az' 'snapshot' 'show' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'snapshot_k8s-agentpool2-33778956-vmss']
2021-04-01T21:28:25.053591166Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['az' 'vmss' 'show' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'k8s-agentpool2-33778956-vmss' '--instance-id' '0']
2021-04-01T21:28:26.390401057Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'annotate' 'node' 'k8s-agentpool2-33778956-vmss000000' 'cluster-autoscaler.kubernetes.io/scale-down-disabled=true' '--overwrite']
2021-04-01T21:28:26.479078051Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'cordon' 'k8s-agentpool2-33778956-vmss000000']
2021-04-01T21:28:26.563964648Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'drain' '--ignore-daemonsets' '--delete-local-data' '--force' '--grace-period' '5' '--timeout' '15s' 'k8s-agentpool2-33778956-vmss000000']
2021-04-01T21:28:40.504320825Z k8s-agentpool2-33778956-vmss	INFO: ===> Completed in 13.94s: ['kubectl' 'drain' '--ignore-daemonsets' '--delete-local-data' '--force' '--grace-period' '5' '--timeout' '15s' 'k8s-agentpool2-33778956-vmss000000'] # RC=0
2021-04-01T21:28:40.504444729Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'delete' '-f' '-'] # Deleting vmss-prototype-tweaks-k8s-agentpool2-33778956-vmss000000 (just in case)
2021-04-01T21:28:40.584632699Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'create' '-f' '-'] # Creating vmss-prototype-tweaks-k8s-agentpool2-33778956-vmss000000
2021-04-01T21:28:41.275190425Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'get' 'pod' '--namespace' 'default' '--output' 'jsonpath={.status.phase}' 'vmss-prototype-tweaks-k8s-agentpool2-33778956-vmss000000']
2021-04-01T21:28:47.713661644Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['az' 'sig' 'image-version' 'list' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2' '--gallery-image-definition' 'kamino-k8s-agentpool1-33778956-vmss-prototype']
2021-04-01T21:28:49.361687639Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'get' 'pod' '--namespace' 'default' '--output' 'jsonpath={.status.phase}' 'vmss-prototype-tweaks-k8s-agentpool2-33778956-vmss000000']
2021-04-01T21:28:57.447647991Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'get' 'pod' '--namespace' 'default' '--output' 'jsonpath={.status.phase}' 'vmss-prototype-tweaks-k8s-agentpool2-33778956-vmss000000']
2021-04-01T21:29:00.863528737Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['az' 'snapshot' 'show' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'snapshot_k8s-agentpool1-33778956-vmss']
2021-04-01T21:29:01.863556175Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['az' 'vmss' 'show' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'k8s-agentpool1-33778956-vmss' '--instance-id' '1']
2021-04-01T21:29:02.944568794Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'annotate' 'node' 'k8s-agentpool1-33778956-vmss000001' 'cluster-autoscaler.kubernetes.io/scale-down-disabled=true' '--overwrite']
2021-04-01T21:29:03.033361379Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'cordon' 'k8s-agentpool1-33778956-vmss000001']
2021-04-01T21:29:03.121895957Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'drain' '--ignore-daemonsets' '--delete-local-data' '--force' '--grace-period' '5' '--timeout' '15s' 'k8s-agentpool1-33778956-vmss000001']
2021-04-01T21:29:05.531483249Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'get' 'pod' '--namespace' 'default' '--output' 'jsonpath={.status.phase}' 'vmss-prototype-tweaks-k8s-agentpool2-33778956-vmss000000']
2021-04-01T21:29:13.619498082Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'get' 'pod' '--namespace' 'default' '--output' 'jsonpath={.status.phase}' 'vmss-prototype-tweaks-k8s-agentpool2-33778956-vmss000000']
2021-04-01T21:29:19.154865560Z k8s-agentpool1-33778956-vmss	WARNING: Attempt 1: Command failed with exit code 1.  Retrying in 8s ...
2021-04-01T21:29:21.702121052Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'get' 'pod' '--namespace' 'default' '--output' 'jsonpath={.status.phase}' 'vmss-prototype-tweaks-k8s-agentpool2-33778956-vmss000000']
2021-04-01T21:29:27.159340275Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'drain' '--ignore-daemonsets' '--delete-local-data' '--force' '--grace-period' '5' '--timeout' '15s' 'k8s-agentpool1-33778956-vmss000001'] #  ... try #2
2021-04-01T21:29:27.668187226Z k8s-agentpool1-33778956-vmss	INFO: ===> Completed in 24.55s: ['kubectl' 'drain' '--ignore-daemonsets' '--delete-local-data' '--force' '--grace-period' '5' '--timeout' '15s' 'k8s-agentpool1-33778956-vmss000001'] # RC=0
2021-04-01T21:29:27.668225227Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'delete' '-f' '-'] # Deleting vmss-prototype-tweaks-k8s-agentpool1-33778956-vmss000001 (just in case)
2021-04-01T21:29:27.739045743Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'create' '-f' '-'] # Creating vmss-prototype-tweaks-k8s-agentpool1-33778956-vmss000001
2021-04-01T21:29:28.008288549Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'get' 'pod' '--namespace' 'default' '--output' 'jsonpath={.status.phase}' 'vmss-prototype-tweaks-k8s-agentpool1-33778956-vmss000001']
2021-04-01T21:29:29.787488174Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'delete' 'pods' '--namespace' 'default' '--grace-period' '0' '--force' 'vmss-prototype-tweaks-k8s-agentpool2-33778956-vmss000000']
2021-04-01T21:29:29.892609769Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['az' 'vmss' 'deallocate' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'k8s-agentpool2-33778956-vmss' '--instance-ids' '0']
2021-04-01T21:29:36.092502476Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'get' 'pod' '--namespace' 'default' '--output' 'jsonpath={.status.phase}' 'vmss-prototype-tweaks-k8s-agentpool1-33778956-vmss000001']
2021-04-01T21:29:42.851731280Z k8s-agentpool2-33778956-vmss	WARNING: Attempt 1: Command failed with exit code 1.  Retrying in 8s ...
2021-04-01T21:29:44.177357713Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'get' 'pod' '--namespace' 'default' '--output' 'jsonpath={.status.phase}' 'vmss-prototype-tweaks-k8s-agentpool1-33778956-vmss000001']
2021-04-01T21:29:50.860212897Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['az' 'vmss' 'deallocate' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'k8s-agentpool2-33778956-vmss' '--instance-ids' '0'] #  ... try #2
2021-04-01T21:29:52.260737513Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'get' 'pod' '--namespace' 'default' '--output' 'jsonpath={.status.phase}' 'vmss-prototype-tweaks-k8s-agentpool1-33778956-vmss000001']
2021-04-01T21:30:00.345906466Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'get' 'pod' '--namespace' 'default' '--output' 'jsonpath={.status.phase}' 'vmss-prototype-tweaks-k8s-agentpool1-33778956-vmss000001']
2021-04-01T21:30:08.433159384Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'get' 'pod' '--namespace' 'default' '--output' 'jsonpath={.status.phase}' 'vmss-prototype-tweaks-k8s-agentpool1-33778956-vmss000001']
2021-04-01T21:30:16.520461222Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'get' 'pod' '--namespace' 'default' '--output' 'jsonpath={.status.phase}' 'vmss-prototype-tweaks-k8s-agentpool1-33778956-vmss000001']
2021-04-01T21:30:24.606762859Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'get' 'pod' '--namespace' 'default' '--output' 'jsonpath={.status.phase}' 'vmss-prototype-tweaks-k8s-agentpool1-33778956-vmss000001']
2021-04-01T21:30:32.694892671Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'delete' 'pods' '--namespace' 'default' '--grace-period' '0' '--force' 'vmss-prototype-tweaks-k8s-agentpool1-33778956-vmss000001']
2021-04-01T21:30:32.780243344Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['az' 'vmss' 'deallocate' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'k8s-agentpool1-33778956-vmss' '--instance-ids' '1']
2021-04-01T21:31:23.482551006Z k8s-agentpool2-33778956-vmss	INFO: ===> Completed in 113.59s: ['az' 'vmss' 'deallocate' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'k8s-agentpool2-33778956-vmss' '--instance-ids' '0'] # RC=0
2021-04-01T21:31:23.482602008Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['az' 'snapshot' 'create' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'snapshot_k8s-agentpool2-33778956-vmss' '--source' '/subscriptions/00000000-0000-0000-0000-000000000001/resourceGroups/testCluster2/providers/Microsoft.Compute/disks/k8s-agentpool2-33778k8s-agentpool2-337789OS__1_5d549e004ca5490e84c82a86f77dcb54' '--tags' 'BuiltFrom=k8s-agentpool2-33778956-vmss000000' 'BuiltAt=2021-04-01 21:31:23.482360']
2021-04-01T21:32:28.599531814Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['az' 'vmss' 'start' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'k8s-agentpool2-33778956-vmss' '--instance-ids' '0' '--no-wait']
2021-04-01T21:32:29.782487153Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'uncordon' 'k8s-agentpool2-33778956-vmss000000']
2021-04-01T21:32:29.876285219Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'annotate' 'node' 'k8s-agentpool2-33778956-vmss000000' 'cluster-autoscaler.kubernetes.io/scale-down-disabled-']
2021-04-01T21:32:29.965644673Z k8s-agentpool2-33778956-vmss	INFO: Creating sig image version - this can take quite a long time...
2021-04-01T21:32:29.965780377Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['az' 'sig' 'image-version' 'create' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2' '--gallery-image-definition' 'kamino-k8s-agentpool2-33778956-vmss-prototype' '--gallery-image-version' '2021.04.01' '--replica-count' '3' '--os-snapshot' 'snapshot_k8s-agentpool2-33778956-vmss' '--tags' 'BuiltFrom=k8s-agentpool2-33778956-vmss000000' 'BuiltAt=2021-04-01 21:31:23.482360' '--storage-account-type' 'Standard_ZRS']
2021-04-01T21:32:35.083747047Z k8s-agentpool1-33778956-vmss	INFO: ===> Completed in 122.30s: ['az' 'vmss' 'deallocate' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'k8s-agentpool1-33778956-vmss' '--instance-ids' '1'] # RC=0
2021-04-01T21:32:35.083828849Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['az' 'snapshot' 'create' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'snapshot_k8s-agentpool1-33778956-vmss' '--source' '/subscriptions/00000000-0000-0000-0000-000000000001/resourceGroups/testCluster2/providers/Microsoft.Compute/disks/k8s-agentpool1-33778k8s-agentpool1-337789OS__1_33c78c2ff87b4bbcad5516f88fab16c1' '--tags' 'BuiltFrom=k8s-agentpool1-33778956-vmss000001' 'BuiltAt=2021-04-01 21:32:35.083641']
2021-04-01T21:32:43.910981266Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['az' 'vmss' 'start' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'k8s-agentpool1-33778956-vmss' '--instance-ids' '1' '--no-wait']
2021-04-01T21:32:47.055532206Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'uncordon' 'k8s-agentpool1-33778956-vmss000001']
2021-04-01T21:32:47.143864731Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['kubectl' 'annotate' 'node' 'k8s-agentpool1-33778956-vmss000001' 'cluster-autoscaler.kubernetes.io/scale-down-disabled-']
2021-04-01T21:32:47.233459689Z k8s-agentpool1-33778956-vmss	INFO: Creating sig image version - this can take quite a long time...
2021-04-01T21:32:47.233523790Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['az' 'sig' 'image-version' 'create' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2' '--gallery-image-definition' 'kamino-k8s-agentpool1-33778956-vmss-prototype' '--gallery-image-version' '2021.04.01' '--replica-count' '3' '--os-snapshot' 'snapshot_k8s-agentpool1-33778956-vmss' '--tags' 'BuiltFrom=k8s-agentpool1-33778956-vmss000001' 'BuiltAt=2021-04-01 21:32:35.083641' '--storage-account-type' 'Standard_ZRS']
2021-04-01T21:43:34.575631298Z k8s-agentpool2-33778956-vmss	INFO: ===> Completed in 664.61s: ['az' 'sig' 'image-version' 'create' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2' '--gallery-image-definition' 'kamino-k8s-agentpool2-33778956-vmss-prototype' '--gallery-image-version' '2021.04.01' '--replica-count' '3' '--os-snapshot' 'snapshot_k8s-agentpool2-33778956-vmss' '--tags' 'BuiltFrom=k8s-agentpool2-33778956-vmss000000' 'BuiltAt=2021-04-01 21:31:23.482360' '--storage-account-type' 'Standard_ZRS'] # RC=0
2021-04-01T21:43:34.575683699Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['az' 'snapshot' 'delete' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'snapshot_k8s-agentpool2-33778956-vmss']
2021-04-01T21:43:51.601287988Z k8s-agentpool1-33778956-vmss	INFO: ===> Completed in 664.37s: ['az' 'sig' 'image-version' 'create' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2' '--gallery-image-definition' 'kamino-k8s-agentpool1-33778956-vmss-prototype' '--gallery-image-version' '2021.04.01' '--replica-count' '3' '--os-snapshot' 'snapshot_k8s-agentpool1-33778956-vmss' '--tags' 'BuiltFrom=k8s-agentpool1-33778956-vmss000001' 'BuiltAt=2021-04-01 21:32:35.083641' '--storage-account-type' 'Standard_ZRS'] # RC=0
2021-04-01T21:43:51.601376391Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['az' 'snapshot' 'delete' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'snapshot_k8s-agentpool1-33778956-vmss']
2021-04-01T21:44:05.711208309Z k8s-agentpool2-33778956-vmss	INFO: Latest image: /subscriptions/00000000-0000-0000-0000-000000000001/resourceGroups/testCluster2/providers/Microsoft.Compute/galleries/SIG_testCluster2/images/kamino-k8s-agentpool2-33778956-vmss-prototype/versions/2021.04.01
2021-04-01T21:44:05.711379114Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['az' 'sig' 'image-version' 'list' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2' '--gallery-image-definition' 'kamino-k8s-agentpool2-33778956-vmss-prototype']
2021-04-01T21:44:18.030317600Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['az' 'vmss' 'show' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'k8s-agentpool2-33778956-vmss']
2021-04-01T21:44:19.028627080Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['az' 'vmss' 'update' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'k8s-agentpool2-33778956-vmss' '--set' 'virtualMachineProfile.storageProfile.imageReference.id=/subscriptions/00000000-0000-0000-0000-000000000001/resourceGroups/testCluster2/providers/Microsoft.Compute/galleries/SIG_testCluster2/images/kamino-k8s-agentpool2-33778956-vmss-prototype' 'virtualMachineProfile.storageProfile.imageReference.sku=null' 'virtualMachineProfile.storageProfile.imageReference.offer=null' 'virtualMachineProfile.storageProfile.imageReference.publisher=null' 'virtualMachineProfile.storageProfile.imageReference.version=null' 'virtualMachineProfile.osProfile.customData=I2Nsb3VkLWNvbmZpZwo=']
2021-04-01T21:44:22.983444364Z k8s-agentpool1-33778956-vmss	INFO: Latest image: /subscriptions/00000000-0000-0000-0000-000000000001/resourceGroups/testCluster2/providers/Microsoft.Compute/galleries/SIG_testCluster2/images/kamino-k8s-agentpool1-33778956-vmss-prototype/versions/2021.04.01
2021-04-01T21:44:22.983580667Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['az' 'sig' 'image-version' 'list' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2' '--gallery-image-definition' 'kamino-k8s-agentpool1-33778956-vmss-prototype']
2021-04-01T21:44:56.620522256Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['az' 'vmss' 'show' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'k8s-agentpool1-33778956-vmss']
2021-04-01T21:44:57.797330529Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['az' 'vmss' 'update' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'k8s-agentpool1-33778956-vmss' '--set' 'virtualMachineProfile.storageProfile.imageReference.id=/subscriptions/00000000-0000-0000-0000-000000000001/resourceGroups/testCluster2/providers/Microsoft.Compute/galleries/SIG_testCluster2/images/kamino-k8s-agentpool1-33778956-vmss-prototype' 'virtualMachineProfile.storageProfile.imageReference.sku=null' 'virtualMachineProfile.storageProfile.imageReference.offer=null' 'virtualMachineProfile.storageProfile.imageReference.publisher=null' 'virtualMachineProfile.storageProfile.imageReference.version=null' 'virtualMachineProfile.osProfile.customData=I2Nsb3VkLWNvbmZpZwo=']
2021-04-01T21:45:17.289477356Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['az' 'vmss' 'show' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'k8s-agentpool1-33778956-vmss']
2021-04-01T21:45:18.357102717Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['az' 'vmss' 'extension' 'list' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--vmss-name' 'k8s-agentpool1-33778956-vmss']
2021-04-01T21:45:19.556287420Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['az' 'vmss' 'extension' 'delete' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--vmss-name' 'k8s-agentpool1-33778956-vmss' '--name' 'vmssCSE']
2021-04-01T21:45:33.188882506Z k8s-agentpool1-33778956-vmss	INFO: ===> Executing command: ['az' 'vmss' 'extension' 'delete' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--vmss-name' 'k8s-agentpool1-33778956-vmss' '--name' 'CustomScriptForLinux']
2021-04-01T21:45:41.338982221Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['az' 'vmss' 'show' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'k8s-agentpool2-33778956-vmss']
2021-04-01T21:45:42.398567018Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['az' 'vmss' 'extension' 'list' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--vmss-name' 'k8s-agentpool2-33778956-vmss']
2021-04-01T21:45:43.377803813Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['az' 'vmss' 'extension' 'delete' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--vmss-name' 'k8s-agentpool2-33778956-vmss' '--name' 'vmssCSE']
2021-04-01T21:46:50.734914752Z k8s-agentpool2-33778956-vmss	INFO: ===> Executing command: ['az' 'vmss' 'extension' 'delete' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--vmss-name' 'k8s-agentpool2-33778956-vmss' '--name' 'CustomScriptForLinux']
2021-04-01T21:49:16.569691278Z auto-update	INFO: ===> Executing command: ['/usr/bin/vmss-prototype' 'status' '--resource-group' 'testCluster2' '--subscription' '00000000-0000-0000-0000-000000000001']
2021-04-01T21:50:14.808741788Z VMSS Prototype Status for cluster:
2021-04-01T21:50:14.808799390Z testCluster2: k8s-agentpool1-33778956-vmss: VMSS Prototype Image Version 2021.04.01 - Succeeded - BuiltFrom: k8s-agentpool1-33778956-vmss000001 @ 2021-04-01 21:32:35.083641
2021-04-01T21:50:14.808806090Z testCluster2: k8s-agentpool1-33778956-vmss: Configured to use latest VMSS Prototype Image Definition
2021-04-01T21:50:14.808810590Z testCluster2: k8s-agentpool2-33778956-vmss: VMSS Prototype Image Version 2021.04.01 - Succeeded - BuiltFrom: k8s-agentpool2-33778956-vmss000000 @ 2021-04-01 21:31:23.482360
2021-04-01T21:50:14.808815490Z testCluster2: k8s-agentpool2-33778956-vmss: Configured to use latest VMSS Prototype Image Definition
```