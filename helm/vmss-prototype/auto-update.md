# Manual Update

This is a higher level description of the basic functions of the VMSS-Prototype Pattern (Kamino) system.  This goes into deep details as to what you are doing on the machine.

## Example

Below is the canonical way to run vmss-prototype on your cluster using our published Helm Chart to do automatic updates to all VMSS pools in the cluster:

```bash
$ helm install --repo https://jackfrancis.github.io/kamino/ \
  update-vmss-model-images \
  vmss-prototype \
  --namespace default \
  --set kamino.scheduleOnControlPlane=true \
  --set kamino.logLevel=DEBUG \
  --set kamino.targetVMSS=ALL \
  --set kamino.auto.lastPatchAnnotation=LatestOSPatch \
  --set kamino.auto.pendingRebootAnnotation=PendingReboot
```


# Annotated logs from a single VMSS cluster run with automatic mode

This cluster has tools that automatically apply OS patches and do reboots as needed, setting the annotations needed.  There is a PR for the open source [Kured](https://github.com/weaveworks/kured) tool that will have it set these annotations as needed but my test environment did not have that custom build so we used our internal tool.

## First run with effectively the above helm command settings

`vmss-prototype` always logs the command line as it starts for easier debugging.
```
2021-01-14T17:08:17.508568931Z CMD: ['/usr/bin/vmss-prototype' '--in-cluster' '--log-level' 'DEBUG' '--log-prefix' 'auto-update' 'auto-update' '--new-updated-nodes' '0' '--grace-period' '5' '--max-history' '3' '--last-patch-annotation' 'LatestOSPatch' '--pending-reboot-annotation' 'PendingReboot' '--minimum-ready-time' '1h' '--minimum-candidates' '1']
```

Note that at this point, all of the auto-update log lines will have "auto-update" prefixed.  (The timestamps are from kubernetes `kubectl logs --timestamps` and are not ones generated by `vmss-prototype`)

`vmss-prototype` logging into the Azure world using the azure.json/node credentials
```
2021-01-14T17:08:17.508621031Z auto-update	INFO: ===> Executing command: ['az' 'cloud' 'set' '--name' 'AzureCloud']
2021-01-14T17:08:19.842976361Z auto-update	INFO: ===> Executing command: ['az' 'login' '***']
2021-01-14T17:08:20.826313834Z auto-update	INFO: ===> Executing command: ['az' 'account' 'set' '--subscription' '00000000-0000-0000-0000-000000000000']
```

`vmss-prototype` is now getting the layout of the cluster
```
2021-01-14T17:08:21.124903169Z auto-update	INFO: ===> Executing command: ['kubectl' 'get' 'nodes' '--output' 'jsonpath={.items[*].metadata.name}']
2021-01-14T17:08:21.836445781Z auto-update	INFO: ===> Executing command: ['kubectl' 'get' 'nodes' '--output' 'json']
```

The first VMSS pool is being evaluated.  Note that since we have no prior images, the "version" is set to 0000.00.00
```
2021-01-14T17:08:22.004337469Z auto-update	INFO: ===> Executing command: ['az' 'sig' 'image-version' 'list' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--gallery-name' 'SIG_testCluster1' '--gallery-image-definition' 'kamino-k8s-agentpool1-12345678-vmss-prototype']
2021-01-14T17:08:24.731700447Z auto-update	DEBUG: Latest image for VMSS k8s-agentpool1-12345678-vmss is 0000.00.00
```

Now we evaluate all of the nodes, filtering out those that are not valid candidates to be a prototype.  Obviously, all of the master nodes are filtered out since they are not in the VMSS.  In this case, none of the VMSS nodes (only 3) were filtered out.  A selection was made to use node `k8s-agentpool1-12345678-vmss000002`
```
2021-01-14T17:08:24.737098582Z auto-update	DEBUG: IGNORED: Node k8s-master-12345678-0 not part of vmss k8s-agentpool1-12345678-vmss
2021-01-14T17:08:24.737123482Z auto-update	DEBUG: IGNORED: Node k8s-master-12345678-1 not part of vmss k8s-agentpool1-12345678-vmss
2021-01-14T17:08:24.737192282Z auto-update	DEBUG: IGNORED: Node k8s-master-12345678-2 not part of vmss k8s-agentpool1-12345678-vmss
2021-01-14T17:08:24.737287783Z auto-update	INFO: VMSS k8s-agentpool1-12345678-vmss: Picked candiate node k8s-agentpool1-12345678-vmss000002 from 3 candidates
2021-01-14T17:08:24.737605985Z auto-update	INFO: ===> Executing command: ['/usr/bin/vmss-prototype' '--log-level' 'DEBUG' '--log-prefix' 'k8s-agentpool1-12345678-vmss' 'update' '--resource-group' 'testCluster1' '--new-updated-nodes' '0' '--max-history' '3' '--grace-period' '5' '--target-node' 'k8s-agentpool1-12345678-vmss000002' '--subscription' '00000000-0000-0000-0000-000000000000']
```

`vmss-prototype` now calls the vmss-prototype update process.  One of these is spawned for each pool that has is discovered to have a need and candidate for prototype update.  Note that the log line prefix changes to the pool this log line is about.  We do that such that multiple VMSS pools being operated on at once can be correctly parsed in the logs.  As this was for testing, we had set a rather short grace-period in order to reduce the time of the test and to show what happens when drain times out (auto-retry)
```
2021-01-14T17:08:24.809937054Z CMD: ['/usr/bin/vmss-prototype' '--log-level' 'DEBUG' '--log-prefix' 'k8s-agentpool1-12345678-vmss' 'update' '--resource-group' 'testCluster1' '--new-updated-nodes' '0' '--max-history' '3' '--grace-period' '5' '--target-node' 'k8s-agentpool1-12345678-vmss000002' '--subscription' '00000000-0000-0000-0000-000000000000']
2021-01-14T17:08:24.809977454Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['kubectl' 'get' 'node' 'k8s-agentpool1-12345678-vmss000002']
2021-01-14T17:08:24.917506551Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'sig' 'show' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--gallery-name' 'SIG_testCluster1']
2021-01-14T17:08:26.278740174Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'sig' 'create' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--gallery-name' 'SIG_testCluster1' '--description' 'Kamino VMSS images']
2021-01-14T17:08:59.907578874Z k8s-agentpool1-12345678-vmss	INFO: Processing VMSS k8s-agentpool1-12345678-vmss
2021-01-14T17:08:59.907799675Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'sig' 'image-definition' 'show' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--gallery-name' 'SIG_testCluster1' '--gallery-image-definition' 'kamino-k8s-agentpool1-12345678-vmss-prototype']
2021-01-14T17:09:01.400376753Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'sig' 'image-definition' 'create' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--gallery-name' 'SIG_testCluster1' '--gallery-image-definition' 'kamino-k8s-agentpool1-12345678-vmss-prototype' '--publisher' 'VMSS-Prototype-Pattern' '--offer' 'testCluster1' '--sku' 'k8s-agentpool1-12345678-vmss' '--os-type' 'Linux' '--os-state' 'generalized']
2021-01-14T17:09:34.847800038Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'sig' 'image-version' 'list' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--gallery-name' 'SIG_testCluster1' '--gallery-image-definition' 'kamino-k8s-agentpool1-12345678-vmss-prototype']
2021-01-14T17:09:37.681615916Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'snapshot' 'show' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--name' 'snapshot_k8s-agentpool1-12345678-vmss']
2021-01-14T17:09:39.159230799Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'vmss' 'show' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--name' 'k8s-agentpool1-12345678-vmss' '--instance-id' '2']
2021-01-14T17:09:40.780999517Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['kubectl' 'annotate' 'node' 'k8s-agentpool1-12345678-vmss000002' 'cluster-autoscaler.kubernetes.io/scale-down-disabled=true' '--overwrite']
2021-01-14T17:09:40.920064219Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['kubectl' 'cordon' 'k8s-agentpool1-12345678-vmss000002']
2021-01-14T17:09:41.055779799Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['kubectl' 'drain' '--ignore-daemonsets' '--delete-local-data' '--force' '--grace-period' '5' '--timeout' '15s' 'k8s-agentpool1-12345678-vmss000002']
2021-01-14T17:09:59.555616890Z k8s-agentpool1-12345678-vmss	WARNING: Attempt 1: Command failed with exit code 1.  Retrying in 8s ...
2021-01-14T17:10:07.562647530Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['kubectl' 'drain' '--ignore-daemonsets' '--delete-local-data' '--force' '--grace-period' '5' '--timeout' '15s' 'k8s-agentpool1-12345678-vmss000002'] #  ... try #2
2021-01-14T17:10:13.384478296Z k8s-agentpool1-12345678-vmss	INFO: ===> Completed in 32.33s: ['kubectl' 'drain' '--ignore-daemonsets' '--delete-local-data' '--force' '--grace-period' '5' '--timeout' '15s' 'k8s-agentpool1-12345678-vmss000002'] # RC=0
2021-01-14T17:10:13.384973400Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'vmss' 'deallocate' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--name' 'k8s-agentpool1-12345678-vmss' '--instance-ids' '2']
2021-01-14T17:13:16.747177869Z k8s-agentpool1-12345678-vmss	INFO: ===> Completed in 183.36s: ['az' 'vmss' 'deallocate' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--name' 'k8s-agentpool1-12345678-vmss' '--instance-ids' '2'] # RC=0
2021-01-14T17:13:16.747427571Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'snapshot' 'create' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--name' 'snapshot_k8s-agentpool1-12345678-vmss' '--source' '/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/testCluster1/providers/Microsoft.Compute/disks/k8s-agentpool1-18861k8s-agentpool1-188617OS__1_31149be82f654bdf8f25e77b8f64afae' '--tags' 'BuiltFrom=k8s-agentpool1-12345678-vmss000002' 'BuiltAt=2021-01-14 17:13:16.747072']
2021-01-14T17:13:22.566227674Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'vmss' 'start' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--name' 'k8s-agentpool1-12345678-vmss' '--instance-ids' '2' '--no-wait']
2021-01-14T17:13:24.087514857Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['kubectl' 'uncordon' 'k8s-agentpool1-12345678-vmss000002']
2021-01-14T17:13:24.212719270Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['kubectl' 'annotate' 'node' 'k8s-agentpool1-12345678-vmss000002' 'cluster-autoscaler.kubernetes.io/scale-down-disabled-']
2021-01-14T17:13:24.341068604Z k8s-agentpool1-12345678-vmss	INFO: Creating sig image version - this can take quite a long time...
2021-01-14T17:13:24.342181812Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'sig' 'image-version' 'create' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--gallery-name' 'SIG_testCluster1' '--gallery-image-definition' 'kamino-k8s-agentpool1-12345678-vmss-prototype' '--gallery-image-version' '2021.01.14' '--replica-count' '3' '--os-snapshot' 'snapshot_k8s-agentpool1-12345678-vmss' '--tags' 'BuiltFrom=k8s-agentpool1-12345678-vmss000002' 'BuiltAt=2021-01-14 17:13:16.747072' '--storage-account-type' 'Standard_ZRS']
2021-01-14T18:57:50.116067018Z k8s-agentpool1-12345678-vmss	INFO: ===> Completed in 6265.77s: ['az' 'sig' 'image-version' 'create' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--gallery-name' 'SIG_testCluster1' '--gallery-image-definition' 'kamino-k8s-agentpool1-12345678-vmss-prototype' '--gallery-image-version' '2021.01.14' '--replica-count' '3' '--os-snapshot' 'snapshot_k8s-agentpool1-12345678-vmss' '--tags' 'BuiltFrom=k8s-agentpool1-12345678-vmss000002' 'BuiltAt=2021-01-14 17:13:16.747072' '--storage-account-type' 'Standard_ZRS'] # RC=0
2021-01-14T18:57:50.116563221Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'snapshot' 'delete' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--name' 'snapshot_k8s-agentpool1-12345678-vmss']
2021-01-14T18:58:21.845822732Z k8s-agentpool1-12345678-vmss	INFO: Latest image: /subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/testCluster1/providers/Microsoft.Compute/galleries/SIG_testCluster1/images/kamino-k8s-agentpool1-12345678-vmss-prototype/versions/2021.01.14
2021-01-14T18:58:21.846029433Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'sig' 'image-version' 'list' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--gallery-name' 'SIG_testCluster1' '--gallery-image-definition' 'kamino-k8s-agentpool1-12345678-vmss-prototype']
2021-01-14T18:58:24.469296948Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'vmss' 'show' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--name' 'k8s-agentpool1-12345678-vmss']
2021-01-14T18:58:25.820369775Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'vmss' 'update' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--name' 'k8s-agentpool1-12345678-vmss' '--set' 'virtualMachineProfile.storageProfile.imageReference.id=/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/testCluster1/providers/Microsoft.Compute/galleries/SIG_testCluster1/images/kamino-k8s-agentpool1-12345678-vmss-prototype' 'virtualMachineProfile.storageProfile.imageReference.sku=null' 'virtualMachineProfile.storageProfile.imageReference.offer=null' 'virtualMachineProfile.storageProfile.imageReference.publisher=null' 'virtualMachineProfile.storageProfile.imageReference.version=null' 'virtualMachineProfile.osProfile.customData=I2Nsb3VkLWNvbmZpZwo=']
2021-01-14T18:58:38.931921916Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'vmss' 'show' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--name' 'k8s-agentpool1-12345678-vmss']
2021-01-14T18:58:40.245728688Z k8s-agentpool1-12345678-vmss	INFO: ===> Executing command: ['az' 'vmss' 'extension' 'list' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--vmss-name' 'k8s-agentpool1-12345678-vmss']
```

Now that everything has completed, the update process continues by asking to render the status of the cluster's prototype images.
```
2021-01-14T18:58:41.788250322Z auto-update	INFO: ===> Executing command: ['/usr/bin/vmss-prototype' 'status' '--resource-group' 'testCluster1' '--subscription' '00000000-0000-0000-0000-000000000000']
2021-01-14T18:58:51.100361012Z VMSS Prototype Status for cluster:
2021-01-14T18:58:51.100407612Z testCluster1: k8s-agentpool1-12345678-vmss: VMSS Prototype Image Version 2021.01.14 - Succeeded - BuiltFrom: k8s-agentpool1-12345678-vmss000002 @ 2021-01-14 17:13:16.747072
2021-01-14T18:58:51.100418112Z testCluster1: k8s-agentpool1-12345678-vmss: Configured to use latest VMSS Prototype Image Definition
```

Note that this cluster now has one VMSS configured to use the image that we just created.  Since this was the first run, there are no historical images.

## A second run of the auto-update

Note that running auto-update again, when there are no new updates available is a no-op and runs relatively quickly.  In our large production clusters we regularly (via a kubernetes cronjob) run the auto update process such that it builds a fresh prototype image automatically after OS patches are deployed and stable.

See how this whole thing completed in less than 15 seconds, including collecting the status of the cluster nodes and prototype images.  On very large clusters, this time is basically the same.  It mainly varies based on Azure API performance in listing the images that have already been created.

```
2021-01-14T20:55:17.378235221Z CMD: ['/usr/bin/vmss-prototype' '--in-cluster' '--log-level' 'DEBUG' '--log-prefix' 'auto-update' 'auto-update' '--new-updated-nodes' '0' '--grace-period' '5' '--max-history' '3' '--last-patch-annotation' 'LatestOSPatch' '--pending-reboot-annotation' 'PendingReboot' '--minimum-ready-time' '1h' '--minimum-candidates' '1']
2021-01-14T20:55:17.378292922Z auto-update	INFO: ===> Executing command: ['az' 'cloud' 'set' '--name' 'AzureCloud']
2021-01-14T20:55:20.436657688Z auto-update	INFO: ===> Executing command: ['az' 'login' '***']
2021-01-14T20:55:21.484097363Z auto-update	INFO: ===> Executing command: ['az' 'account' 'set' '--subscription' '00000000-0000-0000-0000-000000000000']
2021-01-14T20:55:21.802708484Z auto-update	INFO: ===> Executing command: ['kubectl' 'get' 'nodes' '--output' 'jsonpath={.items[*].metadata.name}']
2021-01-14T20:55:22.498723219Z auto-update	INFO: ===> Executing command: ['kubectl' 'get' 'nodes' '--output' 'json']
2021-01-14T20:55:22.677031606Z auto-update	INFO: ===> Executing command: ['az' 'sig' 'image-version' 'list' '--subscription' '00000000-0000-0000-0000-000000000000' '--resource-group' 'testCluster1' '--gallery-name' 'SIG_testCluster1' '--gallery-image-definition' 'kamino-k8s-agentpool1-12345678-vmss-prototype']
2021-01-14T20:55:25.489750037Z auto-update	DEBUG: Latest image for VMSS k8s-agentpool1-12345678-vmss is 2021.01.14
2021-01-14T20:55:25.490229940Z auto-update	DEBUG: IGNORED: Node k8s-agentpool1-12345678-vmss000009 latest patch of 2021.01.10 not newer that latest image version 2021.01.14
2021-01-14T20:55:25.490313041Z auto-update	DEBUG: IGNORED: Node k8s-agentpool1-12345678-vmss00000a latest patch of 2021.01.10 not newer that latest image version 2021.01.14
2021-01-14T20:55:25.490511842Z auto-update	DEBUG: IGNORED: Node k8s-agentpool1-12345678-vmss00000c does not have a last patch annotation: LatestOSPatch
2021-01-14T20:55:25.490595742Z auto-update	DEBUG: IGNORED: Node k8s-agentpool1-12345678-vmss00000d does not have a last patch annotation: LatestOSPatch
2021-01-14T20:55:25.490629143Z auto-update	DEBUG: IGNORED: Node k8s-master-12345678-0 not part of vmss k8s-agentpool1-12345678-vmss
2021-01-14T20:55:25.490687143Z auto-update	DEBUG: IGNORED: Node k8s-master-12345678-1 not part of vmss k8s-agentpool1-12345678-vmss
2021-01-14T20:55:25.490761644Z auto-update	DEBUG: IGNORED: Node k8s-master-12345678-2 not part of vmss k8s-agentpool1-12345678-vmss
2021-01-14T20:55:25.490907945Z auto-update	INFO: IGNORED: VMSS k8s-agentpool1-12345678-vmss: Found 0 candidates - minimum candidates is 1
2021-01-14T20:55:25.491264247Z auto-update	INFO: ===> Executing command: ['/usr/bin/vmss-prototype' 'status' '--resource-group' 'testCluster1' '--subscription' '00000000-0000-0000-0000-000000000000']
2021-01-14T20:55:31.630965033Z VMSS Prototype Status for cluster:
2021-01-14T20:55:31.631010933Z testCluster1: k8s-agentpool1-12345678-vmss: VMSS Prototype Image Version 2021.01.14 - Succeeded - BuiltFrom: k8s-agentpool1-12345678-vmss000002 @ 2021-01-14 17:13:16.747072
2021-01-14T20:55:31.631018933Z testCluster1: k8s-agentpool1-12345678-vmss: Configured to use latest VMSS Prototype Image Definition
```





# Logs from a 2 VMSS cluster run with automatic mode

This cluster has tools that automatically apply OS patches and do reboots as needed, setting the annotations needed.  There is a PR for the open source [Kured](https://github.com/weaveworks/kured) tool that will have it set these annotations as needed but my test environment did not have that custom build so we used our internal tool.

## A first run with the same settings but on a cluster with 2 VMSS pools.

This run is just like the first run on a single pool cluster only it found 2 pools that have prototype candidates to process.  Note how these run in parallel.  Most of the real processing happens in Azure and this one was especially slow - must have had some significant activity within my test subscription at the time.

```
2021-01-14T17:18:56.438975547Z CMD: ['/usr/bin/vmss-prototype' '--in-cluster' '--log-level' 'DEBUG' '--log-prefix' 'auto-update' 'auto-update' '--new-updated-nodes' '0' '--grace-period' '5' '--max-history' '3' '--last-patch-annotation' 'LatestOSPatch' '--pending-reboot-annotation' 'PendingReboot' '--minimum-ready-time' '1h' '--minimum-candidates' '1']
2021-01-14T17:18:56.439046247Z auto-update	INFO: ===> Executing command: ['az' 'cloud' 'set' '--name' 'AzureCloud']
2021-01-14T17:18:59.397722557Z auto-update	INFO: ===> Executing command: ['az' 'login' '***']
2021-01-14T17:19:00.384324492Z auto-update	INFO: ===> Executing command: ['az' 'account' 'set' '--subscription' '00000000-0000-0000-0000-000000000001']
2021-01-14T17:19:00.768999817Z auto-update	INFO: ===> Executing command: ['kubectl' 'get' 'nodes' '--output' 'jsonpath={.items[*].metadata.name}']
2021-01-14T17:19:02.184152151Z auto-update	INFO: ===> Executing command: ['kubectl' 'get' 'nodes' '--output' 'json']
2021-01-14T17:19:02.363603030Z auto-update	INFO: ===> Executing command: ['az' 'sig' 'image-version' 'list' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2' '--gallery-image-definition' 'kamino-k8s-agentpool1-98765432-vmss-prototype']
2021-01-14T17:19:04.394680302Z auto-update	DEBUG: Latest image for VMSS k8s-agentpool1-98765432-vmss is 0000.00.00
2021-01-14T17:19:04.399800376Z auto-update	DEBUG: IGNORED: Node k8s-agentpool1-98765432-vmss00000a has been ready for only 20s and the minimum is 3600s
2021-01-14T17:19:04.399822076Z auto-update	DEBUG: IGNORED: Node k8s-agentpool2-98765432-vmss000009 not part of vmss k8s-agentpool1-98765432-vmss
2021-01-14T17:19:04.399890075Z auto-update	DEBUG: IGNORED: Node k8s-agentpool2-98765432-vmss00000a not part of vmss k8s-agentpool1-98765432-vmss
2021-01-14T17:19:04.399982075Z auto-update	DEBUG: IGNORED: Node k8s-agentpool2-98765432-vmss00000b not part of vmss k8s-agentpool1-98765432-vmss
2021-01-14T17:19:04.400072474Z auto-update	DEBUG: IGNORED: Node k8s-master-98765432-0 not part of vmss k8s-agentpool1-98765432-vmss
2021-01-14T17:19:04.400085174Z auto-update	DEBUG: IGNORED: Node k8s-master-98765432-1 not part of vmss k8s-agentpool1-98765432-vmss
2021-01-14T17:19:04.400171374Z auto-update	DEBUG: IGNORED: Node k8s-master-98765432-2 not part of vmss k8s-agentpool1-98765432-vmss
2021-01-14T17:19:04.400189774Z auto-update	INFO: VMSS k8s-agentpool1-98765432-vmss: Picked candiate node k8s-agentpool1-98765432-vmss000008 from 1 candidates
2021-01-14T17:19:04.400461772Z auto-update	INFO: ===> Executing command: ['/usr/bin/vmss-prototype' '--log-level' 'DEBUG' '--log-prefix' 'k8s-agentpool1-98765432-vmss' 'update' '--resource-group' 'testCluster2' '--new-updated-nodes' '0' '--max-history' '3' '--grace-period' '5' '--target-node' 'k8s-agentpool1-98765432-vmss000008' '--subscription' '00000000-0000-0000-0000-000000000001']
2021-01-14T17:19:04.400978070Z auto-update	INFO: ===> Executing command: ['az' 'sig' 'image-version' 'list' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2' '--gallery-image-definition' 'kamino-k8s-agentpool2-98765432-vmss-prototype']
2021-01-14T17:19:04.488966318Z CMD: ['/usr/bin/vmss-prototype' '--log-level' 'DEBUG' '--log-prefix' 'k8s-agentpool1-98765432-vmss' 'update' '--resource-group' 'testCluster2' '--new-updated-nodes' '0' '--max-history' '3' '--grace-period' '5' '--target-node' 'k8s-agentpool1-98765432-vmss000008' '--subscription' '00000000-0000-0000-0000-000000000001']
2021-01-14T17:19:04.488999818Z k8s-agentpool1-98765432-vmss	INFO: ===> Executing command: ['kubectl' 'get' 'node' 'k8s-agentpool1-98765432-vmss000008']
2021-01-14T17:19:04.676290556Z k8s-agentpool1-98765432-vmss	INFO: ===> Executing command: ['az' 'sig' 'show' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2']
2021-01-14T17:19:06.588209240Z k8s-agentpool1-98765432-vmss	INFO: ===> Executing command: ['az' 'sig' 'create' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2' '--description' 'Kamino VMSS images']
2021-01-14T17:19:07.588451705Z auto-update	DEBUG: Latest image for VMSS k8s-agentpool2-98765432-vmss is 0000.00.00
2021-01-14T17:19:07.588557804Z auto-update	DEBUG: IGNORED: Node k8s-agentpool1-98765432-vmss000008 not part of vmss k8s-agentpool2-98765432-vmss
2021-01-14T17:19:07.588587904Z auto-update	DEBUG: IGNORED: Node k8s-agentpool1-98765432-vmss00000a not part of vmss k8s-agentpool2-98765432-vmss
2021-01-14T17:19:07.589205301Z auto-update	DEBUG: IGNORED: Node k8s-agentpool2-98765432-vmss00000b does not have a last patch annotation: LatestOSPatch
2021-01-14T17:19:07.589222201Z auto-update	DEBUG: IGNORED: Node k8s-master-98765432-0 not part of vmss k8s-agentpool2-98765432-vmss
2021-01-14T17:19:07.589359000Z auto-update	DEBUG: IGNORED: Node k8s-master-98765432-1 not part of vmss k8s-agentpool2-98765432-vmss
2021-01-14T17:19:07.589420800Z auto-update	DEBUG: IGNORED: Node k8s-master-98765432-2 not part of vmss k8s-agentpool2-98765432-vmss
2021-01-14T17:19:07.589618599Z auto-update	INFO: VMSS k8s-agentpool2-98765432-vmss: Picked candiate node k8s-agentpool2-98765432-vmss000009 from 2 candidates
2021-01-14T17:19:07.589950997Z auto-update	INFO: ===> Executing command: ['/usr/bin/vmss-prototype' '--log-level' 'DEBUG' '--log-prefix' 'k8s-agentpool2-98765432-vmss' 'update' '--resource-group' 'testCluster2' '--new-updated-nodes' '0' '--max-history' '3' '--grace-period' '5' '--target-node' 'k8s-agentpool2-98765432-vmss000009' '--subscription' '00000000-0000-0000-0000-000000000001']
2021-01-14T17:19:07.660802133Z CMD: ['/usr/bin/vmss-prototype' '--log-level' 'DEBUG' '--log-prefix' 'k8s-agentpool2-98765432-vmss' 'update' '--resource-group' 'testCluster2' '--new-updated-nodes' '0' '--max-history' '3' '--grace-period' '5' '--target-node' 'k8s-agentpool2-98765432-vmss000009' '--subscription' '00000000-0000-0000-0000-000000000001']
2021-01-14T17:19:07.660842033Z k8s-agentpool2-98765432-vmss	INFO: ===> Executing command: ['kubectl' 'get' 'node' 'k8s-agentpool2-98765432-vmss000009']
2021-01-14T17:19:07.813644349Z k8s-agentpool2-98765432-vmss	INFO: ===> Executing command: ['az' 'sig' 'show' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2']
2021-01-14T17:19:09.384061886Z k8s-agentpool2-98765432-vmss	INFO: Processing VMSS k8s-agentpool2-98765432-vmss
2021-01-14T17:19:09.384511983Z k8s-agentpool2-98765432-vmss	INFO: ===> Executing command: ['az' 'sig' 'image-definition' 'show' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2' '--gallery-image-definition' 'kamino-k8s-agentpool2-98765432-vmss-prototype']
2021-01-14T17:19:10.871751248Z k8s-agentpool2-98765432-vmss	INFO: ===> Executing command: ['az' 'sig' 'image-definition' 'create' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2' '--gallery-image-definition' 'kamino-k8s-agentpool2-98765432-vmss-prototype' '--publisher' 'VMSS-Prototype-Pattern' '--offer' 'testCluster2' '--sku' 'k8s-agentpool2-98765432-vmss' '--os-type' 'Linux' '--os-state' 'generalized']
2021-01-14T17:19:40.569567067Z k8s-agentpool1-98765432-vmss	INFO: Processing VMSS k8s-agentpool1-98765432-vmss
2021-01-14T17:19:40.569802566Z k8s-agentpool1-98765432-vmss	INFO: ===> Executing command: ['az' 'sig' 'image-definition' 'show' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2' '--gallery-image-definition' 'kamino-k8s-agentpool1-98765432-vmss-prototype']
2021-01-14T17:19:42.115806228Z k8s-agentpool1-98765432-vmss	INFO: ===> Executing command: ['az' 'sig' 'image-definition' 'create' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2' '--gallery-image-definition' 'kamino-k8s-agentpool1-98765432-vmss-prototype' '--publisher' 'VMSS-Prototype-Pattern' '--offer' 'testCluster2' '--sku' 'k8s-agentpool1-98765432-vmss' '--os-type' 'Linux' '--os-state' 'generalized']
2021-01-14T17:19:44.743378836Z k8s-agentpool2-98765432-vmss	INFO: ===> Executing command: ['az' 'sig' 'image-version' 'list' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2' '--gallery-image-definition' 'kamino-k8s-agentpool2-98765432-vmss-prototype']
2021-01-14T17:19:46.607442965Z k8s-agentpool2-98765432-vmss	INFO: ===> Executing command: ['az' 'snapshot' 'show' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'snapshot_k8s-agentpool2-98765432-vmss']
2021-01-14T17:19:47.983195601Z k8s-agentpool2-98765432-vmss	INFO: ===> Executing command: ['az' 'vmss' 'show' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'k8s-agentpool2-98765432-vmss' '--instance-id' '9']
2021-01-14T17:19:49.492404751Z k8s-agentpool2-98765432-vmss	INFO: ===> Executing command: ['kubectl' 'annotate' 'node' 'k8s-agentpool2-98765432-vmss000009' 'cluster-autoscaler.kubernetes.io/scale-down-disabled=true' '--overwrite']
2021-01-14T17:19:49.663973270Z k8s-agentpool2-98765432-vmss	INFO: ===> Executing command: ['kubectl' 'cordon' 'k8s-agentpool2-98765432-vmss000009']
2021-01-14T17:19:49.824122448Z k8s-agentpool2-98765432-vmss	INFO: ===> Executing command: ['kubectl' 'drain' '--ignore-daemonsets' '--delete-local-data' '--force' '--grace-period' '5' '--timeout' '15s' 'k8s-agentpool2-98765432-vmss000009']
2021-01-14T17:20:06.040992877Z k8s-agentpool2-98765432-vmss	INFO: ===> Completed in 16.22s: ['kubectl' 'drain' '--ignore-daemonsets' '--delete-local-data' '--force' '--grace-period' '5' '--timeout' '15s' 'k8s-agentpool2-98765432-vmss000009'] # RC=0
2021-01-14T17:20:06.041202276Z k8s-agentpool2-98765432-vmss	INFO: ===> Executing command: ['az' 'vmss' 'deallocate' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'k8s-agentpool2-98765432-vmss' '--instance-ids' '9']
2021-01-14T17:20:15.741634264Z k8s-agentpool1-98765432-vmss	INFO: ===> Executing command: ['az' 'sig' 'image-version' 'list' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2' '--gallery-image-definition' 'kamino-k8s-agentpool1-98765432-vmss-prototype']
2021-01-14T17:20:17.560708123Z k8s-agentpool1-98765432-vmss	INFO: ===> Executing command: ['az' 'snapshot' 'show' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'snapshot_k8s-agentpool1-98765432-vmss']
2021-01-14T17:20:18.897144860Z k8s-agentpool1-98765432-vmss	INFO: ===> Executing command: ['az' 'vmss' 'show' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'k8s-agentpool1-98765432-vmss' '--instance-id' '8']
2021-01-14T17:20:20.486635498Z k8s-agentpool1-98765432-vmss	INFO: ===> Executing command: ['kubectl' 'annotate' 'node' 'k8s-agentpool1-98765432-vmss000008' 'cluster-autoscaler.kubernetes.io/scale-down-disabled=true' '--overwrite']
2021-01-14T17:20:20.618506821Z k8s-agentpool1-98765432-vmss	INFO: ===> Executing command: ['kubectl' 'cordon' 'k8s-agentpool1-98765432-vmss000008']
2021-01-14T17:20:20.751892736Z k8s-agentpool1-98765432-vmss	INFO: ===> Executing command: ['kubectl' 'drain' '--ignore-daemonsets' '--delete-local-data' '--force' '--grace-period' '5' '--timeout' '15s' 'k8s-agentpool1-98765432-vmss000008']
2021-01-14T17:20:36.709331591Z k8s-agentpool1-98765432-vmss	INFO: ===> Completed in 15.96s: ['kubectl' 'drain' '--ignore-daemonsets' '--delete-local-data' '--force' '--grace-period' '5' '--timeout' '15s' 'k8s-agentpool1-98765432-vmss000008'] # RC=0
2021-01-14T17:20:36.710308586Z k8s-agentpool1-98765432-vmss	INFO: ===> Executing command: ['az' 'vmss' 'deallocate' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'k8s-agentpool1-98765432-vmss' '--instance-ids' '8']
2021-01-14T17:22:38.977292908Z k8s-agentpool2-98765432-vmss	INFO: ===> Completed in 152.94s: ['az' 'vmss' 'deallocate' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'k8s-agentpool2-98765432-vmss' '--instance-ids' '9'] # RC=0
2021-01-14T17:22:38.977719805Z k8s-agentpool2-98765432-vmss	INFO: ===> Executing command: ['az' 'snapshot' 'create' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'snapshot_k8s-agentpool2-98765432-vmss' '--source' '/subscriptions/00000000-0000-0000-0000-000000000001/resourceGroups/testCluster2/providers/Microsoft.Compute/disks/k8s-agentpool2-25241k8s-agentpool2-252419OS__1_2f8c0e732ea14af6aff4177d8c746d05' '--tags' 'BuiltFrom=k8s-agentpool2-98765432-vmss000009' 'BuiltAt=2021-01-14 17:22:38.977176']
2021-01-14T17:22:44.800534194Z k8s-agentpool2-98765432-vmss	INFO: ===> Executing command: ['az' 'vmss' 'start' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'k8s-agentpool2-98765432-vmss' '--instance-ids' '9' '--no-wait']
2021-01-14T17:22:46.343851666Z k8s-agentpool2-98765432-vmss	INFO: ===> Executing command: ['kubectl' 'uncordon' 'k8s-agentpool2-98765432-vmss000009']
2021-01-14T17:22:46.493289898Z k8s-agentpool2-98765432-vmss	INFO: ===> Executing command: ['kubectl' 'annotate' 'node' 'k8s-agentpool2-98765432-vmss000009' 'cluster-autoscaler.kubernetes.io/scale-down-disabled-']
2021-01-14T17:22:46.647673405Z k8s-agentpool2-98765432-vmss	INFO: Creating sig image version - this can take quite a long time...
2021-01-14T17:22:46.647949304Z k8s-agentpool2-98765432-vmss	INFO: ===> Executing command: ['az' 'sig' 'image-version' 'create' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2' '--gallery-image-definition' 'kamino-k8s-agentpool2-98765432-vmss-prototype' '--gallery-image-version' '2021.01.14' '--replica-count' '3' '--os-snapshot' 'snapshot_k8s-agentpool2-98765432-vmss' '--tags' 'BuiltFrom=k8s-agentpool2-98765432-vmss000009' 'BuiltAt=2021-01-14 17:22:38.977176' '--storage-account-type' 'Standard_ZRS']
2021-01-14T17:23:09.415517144Z k8s-agentpool1-98765432-vmss	INFO: ===> Completed in 152.71s: ['az' 'vmss' 'deallocate' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'k8s-agentpool1-98765432-vmss' '--instance-ids' '8'] # RC=0
2021-01-14T17:23:09.415769242Z k8s-agentpool1-98765432-vmss	INFO: ===> Executing command: ['az' 'snapshot' 'create' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'snapshot_k8s-agentpool1-98765432-vmss' '--source' '/subscriptions/00000000-0000-0000-0000-000000000001/resourceGroups/testCluster2/providers/Microsoft.Compute/disks/k8s-agentpool1-25241k8s-agentpool1-252419OS__1_3f1fd62025714807acb50c6bca6f8414' '--tags' 'BuiltFrom=k8s-agentpool1-98765432-vmss000008' 'BuiltAt=2021-01-14 17:23:09.415412']
2021-01-14T17:23:14.692467034Z k8s-agentpool1-98765432-vmss	INFO: ===> Executing command: ['az' 'vmss' 'start' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'k8s-agentpool1-98765432-vmss' '--instance-ids' '8' '--no-wait']
2021-01-14T17:23:16.156635412Z k8s-agentpool1-98765432-vmss	INFO: ===> Executing command: ['kubectl' 'uncordon' 'k8s-agentpool1-98765432-vmss000008']
2021-01-14T17:23:16.322424261Z k8s-agentpool1-98765432-vmss	INFO: ===> Executing command: ['kubectl' 'annotate' 'node' 'k8s-agentpool1-98765432-vmss000008' 'cluster-autoscaler.kubernetes.io/scale-down-disabled-']
2021-01-14T17:23:16.461581046Z k8s-agentpool1-98765432-vmss	INFO: Creating sig image version - this can take quite a long time...
2021-01-14T17:23:16.461918444Z k8s-agentpool1-98765432-vmss	INFO: ===> Executing command: ['az' 'sig' 'image-version' 'create' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2' '--gallery-image-definition' 'kamino-k8s-agentpool1-98765432-vmss-prototype' '--gallery-image-version' '2021.01.14' '--replica-count' '3' '--os-snapshot' 'snapshot_k8s-agentpool1-98765432-vmss' '--tags' 'BuiltFrom=k8s-agentpool1-98765432-vmss000008' 'BuiltAt=2021-01-14 17:23:09.415412' '--storage-account-type' 'Standard_ZRS']
2021-01-14T19:28:01.376992211Z k8s-agentpool2-98765432-vmss	INFO: ===> Completed in 7514.73s: ['az' 'sig' 'image-version' 'create' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2' '--gallery-image-definition' 'kamino-k8s-agentpool2-98765432-vmss-prototype' '--gallery-image-version' '2021.01.14' '--replica-count' '3' '--os-snapshot' 'snapshot_k8s-agentpool2-98765432-vmss' '--tags' 'BuiltFrom=k8s-agentpool2-98765432-vmss000009' 'BuiltAt=2021-01-14 17:22:38.977176' '--storage-account-type' 'Standard_ZRS'] # RC=0
2021-01-14T19:28:01.377231610Z k8s-agentpool2-98765432-vmss	INFO: ===> Executing command: ['az' 'snapshot' 'delete' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'snapshot_k8s-agentpool2-98765432-vmss']
2021-01-14T19:28:33.005925221Z k8s-agentpool2-98765432-vmss	INFO: Latest image: /subscriptions/00000000-0000-0000-0000-000000000001/resourceGroups/testCluster2/providers/Microsoft.Compute/galleries/SIG_testCluster2/images/kamino-k8s-agentpool2-98765432-vmss-prototype/versions/2021.01.14
2021-01-14T19:28:33.006624417Z k8s-agentpool2-98765432-vmss	INFO: ===> Executing command: ['az' 'sig' 'image-version' 'list' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2' '--gallery-image-definition' 'kamino-k8s-agentpool2-98765432-vmss-prototype']
2021-01-14T19:28:35.599908237Z k8s-agentpool2-98765432-vmss	INFO: ===> Executing command: ['az' 'vmss' 'show' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'k8s-agentpool2-98765432-vmss']
2021-01-14T19:28:37.046549773Z k8s-agentpool2-98765432-vmss	INFO: ===> Executing command: ['az' 'vmss' 'update' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'k8s-agentpool2-98765432-vmss' '--set' 'virtualMachineProfile.storageProfile.imageReference.id=/subscriptions/00000000-0000-0000-0000-000000000001/resourceGroups/testCluster2/providers/Microsoft.Compute/galleries/SIG_testCluster2/images/kamino-k8s-agentpool2-98765432-vmss-prototype' 'virtualMachineProfile.storageProfile.imageReference.sku=null' 'virtualMachineProfile.storageProfile.imageReference.offer=null' 'virtualMachineProfile.storageProfile.imageReference.publisher=null' 'virtualMachineProfile.storageProfile.imageReference.version=null' 'virtualMachineProfile.osProfile.customData=I2Nsb3VkLWNvbmZpZwo=']
2021-01-14T19:28:49.809322404Z k8s-agentpool2-98765432-vmss	INFO: ===> Executing command: ['az' 'vmss' 'show' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'k8s-agentpool2-98765432-vmss']
2021-01-14T19:28:51.314872103Z k8s-agentpool2-98765432-vmss	INFO: ===> Executing command: ['az' 'vmss' 'extension' 'list' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--vmss-name' 'k8s-agentpool2-98765432-vmss']
2021-01-14T20:56:38.727277567Z k8s-agentpool1-98765432-vmss	INFO: ===> Completed in 12802.26s: ['az' 'sig' 'image-version' 'create' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2' '--gallery-image-definition' 'kamino-k8s-agentpool1-98765432-vmss-prototype' '--gallery-image-version' '2021.01.14' '--replica-count' '3' '--os-snapshot' 'snapshot_k8s-agentpool1-98765432-vmss' '--tags' 'BuiltFrom=k8s-agentpool1-98765432-vmss000008' 'BuiltAt=2021-01-14 17:23:09.415412' '--storage-account-type' 'Standard_ZRS'] # RC=0
2021-01-14T20:56:38.727488666Z k8s-agentpool1-98765432-vmss	INFO: ===> Executing command: ['az' 'snapshot' 'delete' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'snapshot_k8s-agentpool1-98765432-vmss']
2021-01-14T20:57:11.427005726Z k8s-agentpool1-98765432-vmss	INFO: Latest image: /subscriptions/00000000-0000-0000-0000-000000000001/resourceGroups/testCluster2/providers/Microsoft.Compute/galleries/SIG_testCluster2/images/kamino-k8s-agentpool1-98765432-vmss-prototype/versions/2021.01.14
2021-01-14T20:57:11.428335219Z k8s-agentpool1-98765432-vmss	INFO: ===> Executing command: ['az' 'sig' 'image-version' 'list' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--gallery-name' 'SIG_testCluster2' '--gallery-image-definition' 'kamino-k8s-agentpool1-98765432-vmss-prototype']
2021-01-14T20:57:14.189644036Z k8s-agentpool1-98765432-vmss	INFO: ===> Executing command: ['az' 'vmss' 'show' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'k8s-agentpool1-98765432-vmss']
2021-01-14T20:57:15.784717648Z k8s-agentpool1-98765432-vmss	INFO: ===> Executing command: ['az' 'vmss' 'update' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'k8s-agentpool1-98765432-vmss' '--set' 'virtualMachineProfile.storageProfile.imageReference.id=/subscriptions/00000000-0000-0000-0000-000000000001/resourceGroups/testCluster2/providers/Microsoft.Compute/galleries/SIG_testCluster2/images/kamino-k8s-agentpool1-98765432-vmss-prototype' 'virtualMachineProfile.storageProfile.imageReference.sku=null' 'virtualMachineProfile.storageProfile.imageReference.offer=null' 'virtualMachineProfile.storageProfile.imageReference.publisher=null' 'virtualMachineProfile.storageProfile.imageReference.version=null' 'virtualMachineProfile.osProfile.customData=I2Nsb3VkLWNvbmZpZwo=']
2021-01-14T20:57:28.722609171Z k8s-agentpool1-98765432-vmss	INFO: ===> Executing command: ['az' 'vmss' 'show' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--name' 'k8s-agentpool1-98765432-vmss']
2021-01-14T20:57:30.235270184Z k8s-agentpool1-98765432-vmss	INFO: ===> Executing command: ['az' 'vmss' 'extension' 'list' '--subscription' '00000000-0000-0000-0000-000000000001' '--resource-group' 'testCluster2' '--vmss-name' 'k8s-agentpool1-98765432-vmss']
2021-01-14T20:57:31.820532543Z auto-update	INFO: ===> Executing command: ['/usr/bin/vmss-prototype' 'status' '--resource-group' 'testCluster2' '--subscription' '00000000-0000-0000-0000-000000000001']
2021-01-14T20:57:43.674497253Z VMSS Prototype Status for cluster:
2021-01-14T20:57:43.674569253Z testCluster2: k8s-agentpool1-98765432-vmss: VMSS Prototype Image Version 2021.01.14 - Succeeded - BuiltFrom: k8s-agentpool1-98765432-vmss000008 @ 2021-01-14 17:23:09.415412
2021-01-14T20:57:43.674583653Z testCluster2: k8s-agentpool1-98765432-vmss: Configured to use latest VMSS Prototype Image Definition
2021-01-14T20:57:43.674592653Z testCluster2: k8s-agentpool2-98765432-vmss: VMSS Prototype Image Version 2021.01.14 - Succeeded - BuiltFrom: k8s-agentpool2-98765432-vmss000009 @ 2021-01-14 17:22:38.977176
2021-01-14T20:57:43.674604853Z testCluster2: k8s-agentpool2-98765432-vmss: Configured to use latest VMSS Prototype Image Definition
```